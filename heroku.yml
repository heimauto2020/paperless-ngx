setup:
  addons:
    # Free Redis instance for the message broker
    - plan: heroku-redis:hobby-dev
      as: REDIS

build:
  docker:
    # Uses the Dockerfile in the project root (Paperless‑ngx image)
    web: Dockerfile

run:
  # ──────────────────────────────────────────────────────────────
  # Main Paperless web dyno (exposed to the Internet)
  web: /usr/local/bin/gunicorn paperless.asgi:application --bind 0.0.0.0:$PORT

  # Celery worker for background tasks (re‑uses the same image)
  worker:
    command:
      - celery
      - -A
      - paperless
      - worker
      - -l
      - info
    image: web

  # ──────────────────────────────────────────────────────────────
  # Supporting containers (each its own dyno/process type)
  broker:
    image: docker.io/library/redis:8
    command: redis-server --port 6379

  gotenberg:
    image: docker.io/gotenberg/gotenberg:8.20
    command:
      - gotenberg
      - "--chromium-disable-javascript=true"
      - "--chromium-allow-list=file:///tmp/.*"

  tika:
    image: docker.io/apache/tika:latest

# ──────────────────────────────────────────────────────────────
# Run database migrations on each release
release:
  image: web
  command:
    - python
    - manage.py
    - migrate

# ──────────────────────────────────────────────────────────────
# Environment configuration (Heroku substitutes the ADDON URLs)
config:
  PAPERLESS_REDIS: ${REDIS_URL}
  PAPERLESS_DBENGINE: postgresql
  PAPERLESS_DBHOST: ${EXTERNAL_DB_HOST}
  PAPERLESS_DBPORT: ${EXTERNAL_DB_PORT}
  PAPERLESS_DBUSER: ${EXTERNAL_DB_USER}
  PAPERLESS_DBPASS: ${EXTERNAL_DB_PASSWORD}
  PAPERLESS_TIKA_ENABLED: "1"
  PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://gotenberg:3000
  PAPERLESS_TIKA_ENDPOINT: http://tika:9998
  PAPERLESS_CONSUME_DIR: /mnt/gdrive/${USERNAME}/consume
  PAPERLESS_EXPORT_DIR: /mnt/gdrive/${USERNAME}/export

# How many dynos of each type to start by default
formation:
  web:
    quantity: 1
    size: hobby
  worker:
    quantity: 1
    size: free
  broker:
    quantity: 1
    size: free
  gotenberg:
    quantity: 1
    size: free
  tika:
    quantity: 1
    size: free
