# heroku.yml  ─────────────────────────────────────

build:
  docker:
    web: Dockerfile            # Dockerfile im Projekt-Root

run:
  web: /usr/local/bin/gunicorn paperless.asgi:application --bind 0.0.0.0:$PORT

  worker:
    image: web
    command:
      - celery
      - -A
      - paperless
      - worker
      - -l
      - info

  broker:
    image: docker.io/library/redis:8
    command:
      - redis-server
      - --port
      - "6379"

  gotenberg:
    image: docker.io/gotenberg/gotenberg:8.20
    command:
      - gotenberg
      - "--chromium-disable-javascript=true"
      - "--chromium-allow-list=file:///tmp/.*"

  tika:
    image: docker.io/apache/tika:latest
    command:
      - java
      - -jar
      - /tika-server.jar
      - -p
      - "9998"

release:
  image: web
  command:
    - python
    - manage.py
    - migrate

setup:
  addons:
    - plan: heroku-redis:hobby-dev
      as: REDIS

  config:
    PAPERLESS_REDIS: ${REDIS_URL}              # wird vom Add-on gefüllt
    PAPERLESS_DBENGINE: postgresql
    PAPERLESS_DBHOST: ${EXTERNAL_DB_HOST}
    PAPERLESS_DBPORT: ${EXTERNAL_DB_PORT}
    PAPERLESS_DBUSER: ${EXTERNAL_DB_USER}
    PAPERLESS_DBPASS: ${EXTERNAL_DB_PASSWORD}
    PAPERLESS_TIKA_ENABLED: "1"
    PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://gotenberg:3000
    PAPERLESS_TIKA_ENDPOINT: http://tika:9998
    PAPERLESS_CONSUME_DIR: /mnt/gdrive/${USERNAME}/consume
    PAPERLESS_EXPORT_DIR: /mnt/gdrive/${USERNAME}/export
